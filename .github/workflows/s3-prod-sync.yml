name: Manual PROD Deployment (Stage → Prod)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type DEPLOY to confirm PROD deployment"
        required: true
        default: ""

permissions:
  id-token: write
  contents: read

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Validate manual confirmation
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
            echo "❌ Confirmation failed. Type DEPLOY to proceed."
            exit 1
          fi

      # 2️⃣ Checkout repository (needed for paths-filter)
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 3️⃣ Detect which folder changed (same logic as DEV/STAGE)
      - name: Detect changed folders
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            aviation:
              - 'public/aviation/**'
            connect:
              - 'public/connect/**'
            sli:
              - 'public/sli/**'
            investor_insights:
              - 'public/investor-insights/**'

      # 4️⃣ Assume PROD role using OIDC
      - name: Assume PROD role (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PROD_ROLE_ARN }}
          aws-region: ap-south-1

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      # 5️⃣ Sync ONLY aviation (STAGE → PROD)
      - name: Sync aviation to PROD
        if: steps.filter.outputs.aviation == 'true'
        run: |
          aws s3 sync \
            s3://${{ secrets.STAGE_BUCKET_NAME }}/aviation/ \
            s3://${{ secrets.PROD_BUCKET_NAME }}/aviation/ \
            --delete

      # 6️⃣ Sync ONLY connect (STAGE → PROD)
      - name: Sync connect to PROD
        if: steps.filter.outputs.connect == 'true'
        run: |
          aws s3 sync \
            s3://${{ secrets.STAGE_BUCKET_NAME }}/connect/ \
            s3://${{ secrets.PROD_BUCKET_NAME }}/connect/ \
            --delete

      # 7️⃣ Sync ONLY sli (STAGE → PROD)
      - name: Sync sli to PROD
        if: steps.filter.outputs.sli == 'true'
        run: |
          aws s3 sync \
            s3://${{ secrets.STAGE_BUCKET_NAME }}/sli/ \
            s3://${{ secrets.PROD_BUCKET_NAME }}/sli/ \
            --delete

      # 8️⃣ Sync ONLY investor-insights (STAGE → PROD)
      - name: Sync investor-insights to PROD
        if: steps.filter.outputs.investor_insights == 'true'
        run: |
          aws s3 sync \
            s3://${{ secrets.STAGE_BUCKET_NAME }}/investor-insights/ \
            s3://${{ secrets.PROD_BUCKET_NAME }}/investor-insights/ \
            --delete
